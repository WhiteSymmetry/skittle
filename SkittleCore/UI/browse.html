{% extends "base.html" %}
{% block pageTitle %}{{ specimen }} WebSkittle Mockup{% endblock %}
{% block styles %}
	<link rel="stylesheet" type="text/css" href="{{STATIC_URL}}css/browser.css">
	<link rel="stylesheet" type="text/css" href="{{STATIC_URL}}css/popover.css">
	<style type="text/css">

	</style>
	{% endblock %}
	{% block scripts %}
<!--[if lt IE 9]>
    <script src="{{STATIC_URL}}js/excanvas.js"></script>
<![endif]-->
	<script src="/browse/state.json"></script>
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
	<script src="{{STATIC_URL}}js/contactform.js"></script>
	<script src="{{STATIC_URL}}js/md5.js"></script>
	<script src="{{STATIC_URL}}js/utility.js"></script>
	<script src="{{STATIC_URL}}js/interface.js"></script>
	<script src="{{STATIC_URL}}js/draw_canvas.js"></script>
	<script type="text/javascript">


	</script>
	{% endblock %}

{% block content %}
	<div id="canvasContainer">
	    <canvas id="c" width="2000" height="1000"></canvas>
		<div id="graph-labels">
			<ul>
			{% for graph in availableGraphs %}
				<li id="graphLabel-{{ graph.symbol }}" style="width:159px;">{{ graph.name }} <img src="{{STATIC_URL}}gfx/icons/help.png" class="helpGraphButton"><img src="{{STATIC_URL}}gfx/icons/close.png" class="closeGraphButton">
					<div class="graphHelp"><p>This is a graph.</p></div></li>
			{% endfor %}
			</ul>
		</div>
	</div>

	<div id="learn" class="">
		<p style="top:90px;left:460px;width:190px">Select a different genome and chromosome</p>
		<img src="{{STATIC_URL}}gfx/arrow-top-left.png" style="top:62px;left:430px"> 
		<p style="top:55px;left:210px;width:140px">Display and hide available visualizations</p>
		While the Move Tool is selected you can click and drag to reposition the graphs
		<img src="{{STATIC_URL}}gfx/squigy-arrow-left-short.png" style="top:70px;left:140px"> 
		<p style="top:210px;left:160px;width:160px">When selected, clicking nucleotide display will highlight the sequence under the cursor</p>
		<img src="{{STATIC_URL}}gfx/arrow-top-left.png" style="top:180px;left:140px"> 
		<p style="bottom:90px;left:190px;width:160px;text-align:center">Click on the width to enter a specific value to wrap</p>
		<img src="{{STATIC_URL}}gfx/squigy-arrow-down-short.png" style="bottom:33px;left:250px"> 
		<p style="bottom:90px;left:170px;margin-left:20%;width:150px;text-align:center">Scale sets the number of base pairs displayed by a single skixel via color-averaging</p>
		<img src="{{STATIC_URL}}gfx/squigy-arrow-down-short.png" style="bottom:30px;margin-left:20%;left:230px"> 
		<div style="top:340px;right:120px;width:438px">
			<img src="{{STATIC_URL}}gfx/arrow_keys.png" style="top:40px;right:125px">
			<p style="top:0px;right:120px;">scrolls up ten lines</p>
			<p style="top:150px;right:110px;">scrolls down ten lines</p>
			<p style="top:90px;right:0px;width:115px">increases wrap width by one</p>
			<p style="top:90px;right:320px;width:115px;text-align:right">decreases wrap width by one</p>
		</div>
		<p style="bottom:200px;left:810px;width:180px">Drag the edge of nucleotide display to change the wrap width</p>
		<img src="{{STATIC_URL}}gfx/arrow-top-left.png" style="bottom:280px;left:790px;"> 
		<p style="top:300px;left:670px">A tandem repeat!</p>
		<img src="{{STATIC_URL}}gfx/circle-a-tandem.png" style="top:270px;left:420px">
		<p style="top:62px;right:20px;width:280px;"><a href="#" onClick="$('#learn').removeClass('active')">Close this help overlay <img src="{{STATIC_URL}}gfx/squigy-close-button.png" style="top:-7px"></a></p>
	</div>


	<div id="tools">
		<ul>
			<li class="" id="buttonGraphs"><img src="{{STATIC_URL}}gfx/icons/67.png" width="20" height="20">Graphs</li>
			<li class="radio-tools active" data-tool="Move"><img src="{{STATIC_URL}}gfx/icons/41.png" width="20" height="20">Move</li>
			<li class="radio-tools" data-tool="Select"><img src="{{STATIC_URL}}gfx/icons/dialog.png" width="20" height="20">Select</li>
<!-- 			<li class="radio-tools" data-tool="Find"><img src="{{STATIC_URL}}gfx/icons/7.png" width="20" height="20">Find</li>
			<li class="radio-tools" data-tool="Annotate"><img src="{{STATIC_URL}}gfx/icons/39.png" width="20" height="20">Annotate</li> -->
			<li id="link-here"><img src="{{STATIC_URL}}gfx/icons/flag.png" width="20" height="20">Link Here</li>
			<!-- <li><img src="{{STATIC_URL}}gfx/icons/camera.png" width="20" height="20">Screenshot</li> -->
			<!-- <li class="bottom"><img src="{{STATIC_URL}}gfx/icons/cog.png" width="20" height="20">Settings</li> -->
			<li id="bug-report" class="bottom"><img src="{{STATIC_URL}}gfx/icons/bug.png" width="20" height="20">Bug Report</li>
		</ul>
	</div>
	<div id="dials">
		<ul>
			<li>Width: <span id="widthDisplay" data-fn="UIwidthChange">{{ width }} bp</span>
				<div id="widthBubble" class="popover arrow-bottom-center">
					<div class="button" onClick="doubleWidth()">x2</div>
					<div class="button" onClick="halfWidth()">/2</div>
				</div>
			</li>
			<li>Scale: <span id="scaleDisplay" data-fn="UIscaleChange">{{ scale }} bp/skixel</span>
				<div id="scaleBubble" class="popover arrow-bottom-center">
					<div class="button" onClick="setScaleTo(1)">1:1</div>
					<div class="button" onClick="scaleToFile()">Whole File</div>
				</div>
			</li>
			<li>Start Index: <span id="startDisplay" data-fn="UIstartChange">{{ start }}</span>
				<div id="startBubble" class="popover arrow-bottom-center">
					<div class="button" onClick="setStartTo(1)">Top</div>
					<div class="button" onClick="setStartTo('random')">Random</div>
					<div class="button" onClick="goToEnd()">End</div>
				</div>
			</li>
			<li>End Index: <span id="endDisplay" data-fn="UIendChange">23865</span></li>
		</ul>
	</div>


	<div class="popover arrow-left-top" id="graphList">
		<ul>
			{% for graph in availableGraphs %}
			<li><input type="checkbox" id="showGraph-{{ graph.symbol }}" name="showGraph{{ graph.symbol }}"><label for="showGraph{{ graph.symbol }}">{{ graph.name }}</label></li>
			{% endfor %}
		</ul>
	</div>

	<div id="feedbackForm" class="popover arrow-left-bottom active" style="position:absolute;bottom:-16px;left:145px;padding-bottom:20px">
	<form action="/sendFeedback" method="post" accept-charset="utf-8" id="bug-report-form">
		<select id="feedback_type" name="feedback_type">
			<option>Bug Report</option>
			<option>Feature Request</option>
			<option>Comment</option>
		</select>
		<input type="text" id="feedback_sender_email" name="feedback_sender_email" placeholder="email (optional)">
		<input type="checkbox" name="feedback_contact_sender">I wish to be contacted about this
		<h4>Description:</h4>
		<textarea rows="5" name="feedback_content"></textarea>
		<p>(your current view settings will automatically be sent with this report)</p>
		<input type="hidden" name="feedback_current_view" id="feedback_current_view">
		{% csrf_token %}
		<input type="submit" value="Send Feedback">
	</form>
	</div>
	<script type="text/javascript">
    var cc, c, b, a;
    var isDrag = false;
    var dragWidth = false;
    var activeTool = 'Move';

    var isInvalidDisplay = true
    
    // initial values
    xOffset = 0
    specimen = "{{ specimen }}"
    chromosome = "{{ chromosome }}"
    colorPalette = "{{ colorPalette }}"
    start = {{ start }};
    width = {{ width }};
    scale = {{ scale }};
    zoom  = {{ zoom }};
    fileLength = {{ fileLength }};
    skixelsOnScreen = toSkixels($('#canvasContainer').height())*width;
    selectionStart = {{ selectionStart }}
    selectionEnd = {{ selectionEnd }}
    var annotationSelectedStart,annotationSelectedEnd,activeAnnotation = 0

    // if graphs are specified in the url set their visibility
    var initialGraphs = "{{ graphs }}".split('')
    for (var key in graphStatus) {
    	if ($.inArray(key,initialGraphs)>=0) showGraph(key)
    	else hideGraph(key)
    }
	var annotations = {}
	var visibleAnnotations = {}
	var helpLabel = $('<li class="helpLabel">Help<img src="{{STATIC_URL}}gfx/icons/close.png" class="closeHelpButton"></li>')
	var graphHelpContents = {
		'a':'Annotation Display is linked to an annotation file with start and stop positions for tracks.  It aligns these start and stop positions along with the rest of the graphs, expanding to accommodate overlapping annotations as necessary.  The user can select individual annotations and see the full text associated with that annotation.',
		'n':'The four nucleotides of DNA are represented by four colors.  The pixels are arranged across the screen like text, reading from left to right, the jumping to the beginning of the next line when it reaches the width.  If width is set at a multiple of a tandem repeat, the repeat will appear as vertical bars.', 
		'b':'This bar graph shows how often each nucleotide occurs per line.  It uses the same color palette as Nucleotide Display.',
		's':'Use the “Select” tool and click on a line you would like to search for.  You can either click on Nucleotide Display or Sequence Highlighter to pick a sequence.  Given a search sequence, the Highlighter checks every start position on the screen.  The grayscale pixels are start positions that didn’t make the cut.  Light pixels are near misses.  When the Highlighter finds another sequence that is at least 70% the same, it highlights each of the matching nucleotides in bright green. ',
		'm':'Repeat Map is used for identifying tandem repeats without the need for continually adjusting the width in Nucleotide Display.  It identifies periodicity of repeated sequences by checking all possible offsets and scoring 0-100% similarity displayed in grayscale.  The x-axis of the graph represents periodicity, starting at offset 1 on the left and increasing geometrically to offset 6,144 on the right.  This growth curve means that Repeat Map can accurately detect 2bp periodicities simultaneously with segmental duplications.  Vertical white lines show regions that contain tandem repeats.  Most of the graph will be 25-30% gray from random chance.  Black spots are created when two regions with opposite biases are compared as in the case of a CG repeat being compared with an AT repeat region.',
		'o':'Each row is one display line equal to width.  Each column matches one oligomer of fixed size, arranged in alphabetical order (i.e. AA, AC, AG...).  The brightness of the pixel indicates how often that oligomer occurred compared to all the others.',
		'h':'This graph is a heatmap that shows how similar each row is to every other row on the screen.  Red represents positive correlation, blue is negative, with black being neutral.  The red blue spectrum is normalized to account for baseline correlation from genome wide patterns.  The structure of a heatmap is diagonally symmetrical.  The upper right half is mirrored in the bottom left half.  The diagonal red line is self compared with self.  Each pixel represents a comparison between two other lines.  To see which rows are involved in a comparison trace one line straight down and another line to the left.  Where the lines intersect the diagonal indicates the rows being compared.  The Similarity Heatmap is useful to visualize the blocks of similar code found in the genome, such as large tandem repeats, and isochores at all scales.  The patterns in Similarity Heatmap correlate strongly with those generated from Hi-C experiments to map chromosome territories.',
		't':'Threemer detector was designed to detect the weak 3 periodicity signature associated with codons inside protein coding regions.  It is much more sensitive than Repeat Map, but only detects a single periodicity.  Exon annotations are generally marked by a 3-mer spike.  Strong 3-mer signals outside of exon annotation that are not simple repeats merit further research.'
	}

    imageUnrendered = new Image()
    imageUnrendered.src = "{{STATIC_URL}}gfx/checkers.png"
	if (window.location.hash == "#learn") $('#learn').addClass('active')

	$(document).ready(function() {

		cc = document.getElementById('c') //visible canvas - scale will be 3*zoom
		c = cc.getContext("2d");
	    var bb = document.createElement('canvas'); //scratch canvas
	    bb.height = 1000
	    bb.width = 5000
	    b = bb.getContext("2d");
	    var aa = document.createElement('canvas');
	    aa.height = 10000
	    aa.width = 1050
	    a = aa.getContext("2d");


	    init();

	    document.onkeydown = keyListener; 
	    
	    cc.onselectstart = function () { return false; } //fixes a problem where double clicking causes text to get selected on the canvas
	    cc.onmousedown = mouseDown;
	    cc.onmousemove = mouseMove;
	    cc.onmouseup = mouseUp;
	    cc.onmousewheel = mouseWheel;
	    $('#dials li').on('mousewheel',mouseWheelDials)

	contactForm();


	})
	</script>
{% endblock %}